<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Driver - Uber Clone</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Routing -->
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

    <!-- SignalR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>

    <style>
        html, body {
            height: 100%;
            margin: 0;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        /* TRIPS PANEL */
        #tripsPanel {
            position: fixed;
            top: 10px;
            left: 10px;
            width: 350px;
            max-height: 500px;
            overflow-y: auto;
            padding: 12px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            border-radius: 12px;
            z-index: 9999;
            font-family: Arial;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

            #tripsPanel h3 {
                margin-top: 0;
                text-align: center;
                margin-bottom: 15px;
            }

        .trip-item {
            padding: 12px;
            background: rgba(255,255,255,0.1);
            border-left: 4px solid #4caf50;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

            .trip-item:hover {
                background: rgba(255,255,255,0.15);
                transform: translateY(-2px);
            }

            .trip-item.accepted {
                border-left-color: #2196f3;
                background: rgba(33, 150, 243, 0.1);
            }

            .trip-item.started {
                border-left-color: #ff9800;
                background: rgba(255, 152, 0, 0.1);
            }

            .trip-item.ended {
                border-left-color: #f44336;
                background: rgba(244, 67, 54, 0.1);
            }

        .trip-controls {
            margin-top: 10px;
            display: flex;
            gap: 8px;
        }

            .trip-controls button {
                padding: 8px 12px;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 12px;
                font-weight: bold;
                transition: all 0.3s;
            }

        .btn-accept {
            background: #4caf50;
            color: white;
        }

            .btn-accept:hover {
                background: #45a049;
                transform: translateY(-1px);
            }

        .btn-start {
            background: #ff9800;
            color: white;
        }

            .btn-start:hover {
                background: #f57c00;
                transform: translateY(-1px);
            }

        .btn-end {
            background: #f44336;
            color: white;
        }

            .btn-end:hover {
                background: #d32f2f;
                transform: translateY(-1px);
            }

        .btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        #activeTripInfo {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px;
            border-radius: 12px;
            z-index: 9999;
            font-family: Arial;
            max-width: 320px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            border-left: 4px solid #2196f3;
        }

        .zone-label {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            pointer-events: none;
            border: 2px solid #3388ff;
        }

        #connectionStatus {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-family: Arial;
            font-size: 12px;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .status-connected {
            color: #4caf50;
        }

        .status-disconnected {
            color: #f44336;
        }

        .status-reconnecting {
            color: #ff9800;
        }

        #debugInfo {
            position: fixed;
            bottom: 50px;
            left: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-family: Arial;
            font-size: 10px;
            z-index: 9999;
            max-width: 400px;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        #movementInfo {
            position: fixed;
            bottom: 90px;
            left: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-family: Arial;
            font-size: 12px;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .route-legend {
            position: fixed;
            top: 150px;
            left: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-family: Arial;
            font-size: 12px;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 6px 0;
        }

        .legend-color {
            width: 24px;
            height: 4px;
            margin-right: 10px;
            border-radius: 2px;
        }

        #authPanel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 30px;
            border-radius: 12px;
            z-index: 10000;
            font-family: Arial;
            width: 400px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
        }

        .form-group {
            margin-bottom: 15px;
        }

            .form-group label {
                display: block;
                margin-bottom: 5px;
                font-weight: bold;
            }

            .form-group input {
                width: 100%;
                padding: 12px;
                border: 1px solid #444;
                border-radius: 6px;
                box-sizing: border-box;
                background: rgba(255,255,255,0.1);
                color: white;
            }

            .form-group button {
                width: 100%;
                padding: 12px;
                background: #4caf50;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 16px;
                font-weight: bold;
            }

        .trip-status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 8px;
        }

        .status-requested {
            background: #ff9800;
            color: black;
        }

        .status-accepted {
            background: #2196f3;
            color: white;
        }

        .status-started {
            background: #4caf50;
            color: white;
        }

        .status-ended {
            background: #f44336;
            color: white;
        }

        .trip-progress {
            margin: 10px 0;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            padding: 8px;
            font-size: 12px;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .progress-step {
            text-align: center;
            flex: 1;
            font-size: 10px;
            opacity: 0.6;
        }

            .progress-step.active {
                opacity: 1;
                font-weight: bold;
                color: #4caf50;
            }

        .navigation-controls {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

            .navigation-controls button {
                flex: 1;
                padding: 10px;
            }
    </style>
</head>

<body>
    <!-- Authentication Panel -->
    <div id="authPanel">
        <h3 style="text-align: center; margin-bottom: 20px;">üîë Driver Authentication</h3>
        <div class="form-group">
            <label for="driverToken">JWT Token:</label>
            <input type="text" id="driverToken" placeholder="Enter your JWT token">
        </div>
        <div class="form-group">
            <button onclick="initializeApp()">Start Driving</button>
        </div>
    </div>

    <!-- Side panel showing zone trips -->
    <div id="tripsPanel" style="display: none;">
        <h3>üì¶ Available Trips</h3>
        <div id="tripsList"></div>
    </div>

    <!-- Active trip information -->
    <div id="activeTripInfo" style="display: none;">
        <h3>üöó Active Trip <span id="tripStatusBadge" class="trip-status-badge status-accepted"></span></h3>
        <div id="activeTripDetails"></div>
        <div class="trip-progress">
            <div class="progress-steps">
                <div class="progress-step" id="step1">To Pickup</div>
                <div class="progress-step" id="step2">To Destination</div>
                <div class="progress-step" id="step3">Completed</div>
            </div>
        </div>
        <div id="tripNavigation" class="navigation-controls"></div>
    </div>

    <!-- Route Legend -->
    <div id="routeLegend" class="route-legend" style="display: none;">
        <h4 style="margin: 0 0 10px 0; text-align: center;">Route Legend</h4>
        <div class="legend-item">
            <div class="legend-color" style="background: #2196f3;"></div>
            <span>To Pickup</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #4caf50;"></div>
            <span>To Destination</span>
        </div>
    </div>

    <!-- Movement Info -->
    <div id="movementInfo" style="display: none;">
        üí° Click anywhere on map to move car
    </div>

    <!-- Connection Status -->
    <div id="connectionStatus" style="display: none;">
        Status: <span id="statusText" class="status-disconnected">Disconnected</span>
        <button onclick="toggleDebug()" style="margin-left: 10px; padding: 4px 8px; font-size: 10px; background: #666;">Debug</button>
    </div>

    <div id="debugInfo">
        <div id="debugContent"></div>
    </div>

    <div id="map" style="display: none;"></div>

    <script>
        // =======================================
        // üîë AUTHENTICATION & INITIALIZATION
        // =======================================
        let token = null;
        let connection = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 10;
        let isAppInitialized = false;
        let pendingTripData = null;

        function initializeApp() {
            token = document.getElementById('driverToken').value.trim();

            if (!token) {
                alert('Please enter a valid JWT token');
                return;
            }

            // Hide auth panel, show app
            document.getElementById('authPanel').style.display = 'none';
            document.getElementById('map').style.display = 'block';
            document.getElementById('tripsPanel').style.display = 'block';
            document.getElementById('movementInfo').style.display = 'block';
            document.getElementById('connectionStatus').style.display = 'block';

            initializeMap();
            initializeConnection();
            startHub();

            isAppInitialized = true;
        }

        // =======================================
        // üõ∞Ô∏è SIGNALR CONNECTION WITH IMPROVED RECONNECTION
        // =======================================
        function initializeConnection() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("https://localhost:7229/Wasalnyy", {
                    accessTokenFactory: () => token,
                    transport: signalR.HttpTransportType.LongPolling | signalR.HttpTransportType.ServerSentEvents | signalR.HttpTransportType.WebSockets
                })
                .withAutomaticReconnect({
                    nextRetryDelayInMilliseconds: retryContext => {
                        reconnectAttempts = retryContext.previousRetryCount;
                        if (retryContext.previousRetryCount >= maxReconnectAttempts) {
                            return null;
                        }
                        return Math.min(1000 * Math.pow(2, retryContext.previousRetryCount), 30000);
                    }
                })
                .configureLogging(signalR.LogLevel.Warning)
                .build();

            setupConnectionHandlers();
        }

        function setupConnectionHandlers() {
            connection.onreconnecting(error => {
                updateConnectionStatus('reconnecting', 'Reconnecting...');
                addDebugLog(`Reconnecting due to: ${error?.message || 'Unknown error'}`);
            });

            connection.onreconnected(connectionId => {
                reconnectAttempts = 0;
                updateConnectionStatus('connected', 'Connected');
                addDebugLog(`Reconnected with ID: ${connectionId}`);

                // Restore state after reconnection
                setTimeout(() => {
                    callSetAsAvailable();
                    if (activeTrip) {
                        addDebugLog('Restoring active trip after reconnection');
                    }
                }, 1000);
            });

            connection.onclose(error => {
                updateConnectionStatus('disconnected', 'Disconnected');
                addDebugLog(`Connection closed: ${error?.message || 'Unknown reason'}`);

                // Attempt to reconnect if not manual closure
                if (error) {
                    setTimeout(startHub, 5000);
                }
            });

            // SignalR event handlers
            connection.on("availableTripsInZone", (trips) => {
                console.log("üì¢ Trips received from zone:", trips);
                addDebugLog(`Received ${Array.isArray(trips) ? trips.length : 1} trip(s)`);

                // Only show available trips if no active trip
                if (!activeTrip) {
                    showTrips(trips);
                }
            });

            connection.on("tripStarted", (trip) => {
                console.log("üöó Trip started:", trip);
                activeTrip = trip.id;
                currentTripData = trip;
                updateTripProgress('started');
                showActiveTripInfo(trip);
                updateTripUI();
                addDebugLog(`Trip started: ${trip.id}`);

                if (trip.pickupCoordinates && trip.distinationCoordinates) {
                    showBothRoutes(trip.pickupCoordinates, trip.distinationCoordinates);
                }
            });

            connection.on("tripEnded", (trip) => {
                console.log("üèÅ Trip ended:", trip);
                activeTrip = null;
                currentTripData = null;
                document.getElementById('activeTripInfo').style.display = 'none';
                document.getElementById('routeLegend').style.display = 'none';
                updateTripUI();
                addDebugLog(`Trip ended: ${trip.id}`);

                // Show available trips panel again
                document.getElementById('tripsPanel').style.display = 'block';
                document.getElementById('tripsPanel').querySelector('h3').textContent = 'üì¶ Available Trips';

                cleanupRoutesAndMarkers();
            });

            connection.on("pendingTrip", (trip) => {
                console.log("üîÑ Pending trip restored:", trip);
                pendingTripData = trip;
                activeTrip = trip.id;
                currentTripData = trip;

                // Hide available trips, show active trip
                document.getElementById('tripsPanel').style.display = 'none';
                showActiveTripInfo(trip);
                updateTripUI();
                addDebugLog(`Pending trip restored: ${trip.id}`);

                if (trip.pickupCoordinates && trip.distinationCoordinates) {
                    showBothRoutes(trip.pickupCoordinates, trip.distinationCoordinates);
                }

                // Update progress based on trip status
                if (trip.tripStatus === 'Accepted') {
                    updateTripProgress('accepted');
                } else if (trip.tripStatus === 'Started') {
                    updateTripProgress('started');
                }
            });

            connection.on("onerror", (error) => {
                console.error("‚ùå SignalR error:", error);
                addDebugLog(`SignalR error: ${error}`);
            });
        }

        async function startHub() {
            try {
                if (connection && connection.state === signalR.HubConnectionState.Connected) {
                    return;
                }

                updateConnectionStatus('reconnecting', 'Connecting...');
                addDebugLog('Starting connection...');

                await connection.start();
                reconnectAttempts = 0;
                updateConnectionStatus('connected', 'Connected');
                addDebugLog('Successfully connected to SignalR hub');

                console.log("‚úî Connected to SignalR Hub");
                callSetAsAvailable();

            } catch (err) {
                reconnectAttempts++;
                updateConnectionStatus('disconnected', 'Connection Failed');

                let errorMessage = err.message;
                if (err.statusCode === 401) {
                    errorMessage = "Authentication failed - Token may be expired";
                } else if (err.statusCode === 404) {
                    errorMessage = "Hub endpoint not found - Check server configuration";
                }

                addDebugLog(`Connection failed (attempt ${reconnectAttempts}): ${errorMessage}`);
                console.error("‚ùå Error connecting to hub:", err);

                if (reconnectAttempts < maxReconnectAttempts) {
                    const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
                    addDebugLog(`Retrying in ${delay}ms...`);
                    setTimeout(startHub, delay);
                } else {
                    addDebugLog('Max reconnection attempts reached. Please refresh the page.');
                }
            }
        }

        // =======================================
        // üó∫Ô∏è MAP INITIALIZATION
        // =======================================
        let map, carMarker, pickupMarker, destinationMarker;
        let pickupRouteControl, destinationRouteControl;
        let activeTrip = null;
        let currentTripData = null;
        let isAnimating = false;

        function initializeMap() {
            map = L.map("map").setView([30.06, 31.40], 12);
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

            drawZones();

            const carIcon = L.icon({
                iconUrl: "car.png",
                iconSize: [70, 70],
                iconAnchor: [35, 35]
            });

            const pickupIcon = L.icon({
                iconUrl: "https://cdn-icons-png.flaticon.com/512/684/684908.png",
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });

            const destinationIcon = L.icon({
                iconUrl: "https://cdn-icons-png.flaticon.com/512/3474/3474365.png",
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });

            carMarker = L.marker([30.06, 31.40], { icon: carIcon }).addTo(map);
            pickupMarker = null;
            destinationMarker = null;

            // Map click handler for moving car
            map.on("click", (e) => {
                if (isAnimating) {
                    addDebugLog("Already moving, please wait...");
                    return;
                }

                const start = carMarker.getLatLng();
                const end = e.latlng;

                addDebugLog(`Moving from ${start.lat.toFixed(4)}, ${start.lng.toFixed(4)} to ${end.lat.toFixed(4)}, ${end.lng.toFixed(4)}`);

                const tempRouteControl = L.Routing.control({
                    waypoints: [start, end],
                    createMarker: () => null,
                    show: false,
                    addWaypoints: false,
                    routeWhileDragging: false
                }).addTo(map);

                tempRouteControl.on("routesfound", (evt) => {
                    map.removeControl(tempRouteControl);
                    animateCar(evt.routes[0].coordinates);
                });
            });
        }

        // =======================================
        // üó∫Ô∏è ZONES DATA & DRAWING
        // =======================================
        const zones = [
            {
                "id": "Zone_1",
                "center": { "lat": 29.9, "lng": 31 },
                "coordinates": [
                    { "lat": 29.886486486486486, "lng": 30.984388949539976 },
                    { "lat": 29.886486486486486, "lng": 31.015611050460024 },
                    { "lat": 29.91351351351351, "lng": 31.015611050460024 },
                    { "lat": 29.91351351351351, "lng": 30.984388949539976 },
                    { "lat": 29.886486486486486, "lng": 30.984388949539976 }
                ]
            },
            // ... (other zones remain the same)
        ];

        function drawZones() {
            zones.forEach(zone => {
                const polygon = L.polygon(zone.coordinates, {
                    color: '#3388ff',
                    weight: 2,
                    fillColor: '#3388ff',
                    fillOpacity: 0.1,
                }).addTo(map);

                L.marker(zone.center, {
                    icon: L.divIcon({
                        className: 'zone-label',
                        html: zone.id,
                        iconSize: [60, 20],
                        iconAnchor: [30, 10]
                    })
                }).addTo(map);

                polygon.on('mouseover', function () {
                    this.setStyle({ fillOpacity: 0.2, weight: 3 });
                });
                polygon.on('mouseout', function () {
                    this.setStyle({ fillOpacity: 0.1, weight: 2 });
                });
            });
        }

        // =======================================
        // üöó CAR ANIMATION
        // =======================================
        function animateCar(coords) {
            if (isAnimating) return;

            isAnimating = true;
            let i = 0;

            const interval = setInterval(() => {
                if (i >= coords.length) {
                    clearInterval(interval);
                    isAnimating = false;

                    if (activeTrip && currentTripData && currentTripData.pickupCoordinates && currentTripData.distinationCoordinates) {
                        showBothRoutes(currentTripData.pickupCoordinates, currentTripData.distinationCoordinates);
                    }
                    return;
                }

                const { lat, lng } = coords[i];
                carMarker.setLatLng([lat, lng]);
                updateDriverLocation(lat, lng);
                i++;
            }, 300);
        }

        // =======================================
        // üì° API CALLS WITH RETRY MECHANISM
        // =======================================
        async function apiCallWithRetry(url, options, maxRetries = 3) {
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return response;

                    if (attempt === maxRetries) {
                        throw new Error(`API call failed after ${maxRetries} attempts: ${response.status}`);
                    }
                } catch (error) {
                    if (attempt === maxRetries) throw error;
                    await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                }
            }
        }

        function callSetAsAvailable() {
            apiCallWithRetry("https://localhost:7229/api/Driver/SetAsAvailable", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`
                },
                body: JSON.stringify({ lat: 30.06, lng: 31.40 })
            })
                .then(response => {
                    console.log("‚úî Driver SetAsAvailable called");
                    addDebugLog("Set as available successfully");
                })
                .catch(error => {
                    console.error("‚ùå SetAsAvailable error:", error);
                    addDebugLog(`SetAsAvailable error: ${error.message}`);
                });
        }

        function updateDriverLocation(lat, lng) {
            fetch("https://localhost:7229/api/Driver/UpdateLocation", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`
                },
                body: JSON.stringify({ lat, lng })
            })
                .catch(error => {
                    console.error("‚ùå UpdateLocation error:", error);
                });
        }

        // =======================================
        // üß≠ ROUTE MANAGEMENT
        // =======================================
        function showBothRoutes(pickupCoords, destinationCoords) {
            cleanupRoutesAndMarkers();

            const carPosition = carMarker.getLatLng();
            const pickupPosition = L.latLng(pickupCoords.lat, pickupCoords.lng);
            const destinationPosition = L.latLng(destinationCoords.lat, destinationCoords.lng);

            pickupMarker = L.marker(pickupPosition, { icon: pickupIcon })
                .addTo(map)
                .bindPopup('üìç Pickup Location')
                .openPopup();

            destinationMarker = L.marker(destinationPosition, { icon: destinationIcon })
                .addTo(map)
                .bindPopup('üéØ Destination')
                .openPopup();

            // Create routes with retry mechanism
            createRouteWithRetry(carPosition, pickupPosition, '#2196f3', 'pickup')
                .then(control => {
                    pickupRouteControl = control;
                    return createRouteWithRetry(pickupPosition, destinationPosition, '#4caf50', 'destination');
                })
                .then(control => {
                    destinationRouteControl = control;
                    document.getElementById('routeLegend').style.display = 'block';

                    const group = new L.FeatureGroup([carMarker, pickupMarker, destinationMarker]);
                    map.fitBounds(group.getBounds().pad(0.1));
                    addDebugLog(`Showing both routes: pickup and destination`);
                })
                .catch(error => {
                    console.error("‚ùå Route creation failed:", error);
                    addDebugLog(`Route creation failed: ${error.message}`);
                });
        }

        function createRouteWithRetry(start, end, color, routeType, maxRetries = 3) {
            return new Promise((resolve, reject) => {
                let attempts = 0;

                function attempt() {
                    const control = L.Routing.control({
                        waypoints: [start, end],
                        createMarker: () => null,
                        show: true,
                        addWaypoints: false,
                        routeWhileDragging: false,
                        lineOptions: {
                            styles: [{ color: color, weight: 5, opacity: 0.7 }]
                        }
                    }).addTo(map);

                    // Set timeout for route calculation
                    const timeout = setTimeout(() => {
                        map.removeControl(control);
                        attempts++;

                        if (attempts < maxRetries) {
                            addDebugLog(`Retrying ${routeType} route calculation (attempt ${attempts + 1})`);
                            attempt();
                        } else {
                            reject(new Error(`Failed to calculate ${routeType} route after ${maxRetries} attempts`));
                        }
                    }, 10000);

                    control.on("routesfound", (evt) => {
                        clearTimeout(timeout);
                        if (evt.routes && evt.routes.length > 0) {
                            resolve(control);
                        } else {
                            map.removeControl(control);
                            reject(new Error(`No routes found for ${routeType}`));
                        }
                    });

                    control.on("routingerror", (error) => {
                        clearTimeout(timeout);
                        map.removeControl(control);
                        attempts++;

                        if (attempts < maxRetries) {
                            addDebugLog(`Retrying ${routeType} route after error (attempt ${attempts + 1})`);
                            attempt();
                        } else {
                            reject(new Error(`Routing error for ${routeType}: ${error.error.message}`));
                        }
                    });
                }

                attempt();
            });
        }

        function cleanupRoutesAndMarkers() {
            if (pickupMarker) {
                map.removeLayer(pickupMarker);
                pickupMarker = null;
            }
            if (destinationMarker) {
                map.removeLayer(destinationMarker);
                destinationMarker = null;
            }
            if (pickupRouteControl) {
                map.removeControl(pickupRouteControl);
                pickupRouteControl = null;
            }
            if (destinationRouteControl) {
                map.removeControl(destinationRouteControl);
                destinationRouteControl = null;
            }
        }

        // =======================================
        // üß© TRIP MANAGEMENT FUNCTIONS
        // =======================================
        function acceptTrip(tripId) {
            console.log("üîÑ Accepting trip:", tripId);
            addDebugLog(`Accepting trip: ${tripId}`);

            const tripElement = document.querySelector(`[data-trip-id="${tripId}"]`);
            if (!tripElement) {
                console.error("‚ùå Trip not found in UI");
                return;
            }

            const tripText = tripElement.textContent;
            const pickupMatch = tripText.match(/Pickup:\s*([\d.-]+),\s*([\d.-]+)/);
            const destinationMatch = tripText.match(/Destination:\s*([\d.-]+),\s*([\d.-]+)/);

            if (!pickupMatch || !destinationMatch) {
                console.error("‚ùå Could not extract coordinates from trip");
                return;
            }

            const tripData = {
                id: tripId,
                tripStatus: 'Accepted',
                pickupCoordinates: {
                    lat: parseFloat(pickupMatch[1]),
                    lng: parseFloat(pickupMatch[2])
                },
                distinationCoordinates: {
                    lat: parseFloat(destinationMatch[1]),
                    lng: parseFloat(destinationMatch[2])
                }
            };

            apiCallWithRetry("https://localhost:7229/api/Driver/AcceptTrip", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`
                },
                body: JSON.stringify(tripId)
            })
                .then(async response => {
                    if (response.ok) {
                        console.log("‚úî Trip accepted successfully");
                        addDebugLog("Trip accepted successfully");
                        activeTrip = tripId;
                        currentTripData = tripData;

                        // Hide available trips, show active trip
                        document.getElementById('tripsPanel').style.display = 'none';

                        showBothRoutes(tripData.pickupCoordinates, tripData.distinationCoordinates);
                        updateTripUI();
                        showActiveTripInfo(tripData);
                        updateTripProgress('accepted');
                    } else {
                        const errorText = await response.text();
                        console.error("‚ùå AcceptTrip failed:", response.status, errorText);
                        addDebugLog(`AcceptTrip failed: ${response.status} - ${errorText}`);
                    }
                })
                .catch(error => {
                    console.error("‚ùå AcceptTrip error:", error);
                    addDebugLog(`AcceptTrip error: ${error.message}`);
                });
        }

        function startTrip(tripId) {
            console.log("üîÑ Starting trip:", tripId);
            addDebugLog(`Starting trip: ${tripId}`);

            apiCallWithRetry("https://localhost:7229/api/Driver/StartTrip", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`
                },
                body: JSON.stringify(tripId)
            })
                .then(async response => {
                    if (response.ok) {
                        console.log("‚úî Trip started successfully");
                        addDebugLog("Trip started successfully");

                        if (currentTripData) {
                            currentTripData.tripStatus = 'Started';
                        }

                        updateTripUI();
                        showActiveTripInfo(currentTripData);
                        updateTripProgress('started');
                    } else {
                        const errorText = await response.text();
                        console.error("‚ùå StartTrip failed:", response.status, errorText);
                        addDebugLog(`StartTrip failed: ${response.status} - ${errorText}`);
                    }
                })
                .catch(error => {
                    console.error("‚ùå StartTrip error:", error);
                    addDebugLog(`StartTrip error: ${error.message}`);
                });
        }

        function endTrip(tripId) {
            console.log("üîÑ Ending trip:", tripId);
            addDebugLog(`Ending trip: ${tripId}`);

            apiCallWithRetry("https://localhost:7229/api/Driver/EndTrip", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`
                },
                body: JSON.stringify(tripId)
            })
                .then(async response => {
                    if (response.ok) {
                        console.log("‚úî Trip ended successfully");
                        addDebugLog("Trip ended successfully");
                        activeTrip = null;
                        currentTripData = null;
                        document.getElementById('activeTripInfo').style.display = 'none';
                        document.getElementById('routeLegend').style.display = 'none';
                        updateTripUI();

                        // Show available trips panel again
                        document.getElementById('tripsPanel').style.display = 'block';
                        document.getElementById('tripsPanel').querySelector('h3').textContent = 'üì¶ Available Trips';

                        cleanupRoutesAndMarkers();
                    } else {
                        const errorText = await response.text();
                        console.error("‚ùå EndTrip failed:", response.status, errorText);
                        addDebugLog(`EndTrip failed: ${response.status} - ${errorText}`);
                    }
                })
                .catch(error => {
                    console.error("‚ùå EndTrip error:", error);
                    addDebugLog(`EndTrip error: ${error.message}`);
                });
        }

        // =======================================
        // üìã UI MANAGEMENT FUNCTIONS
        // =======================================
        function updateTripUI() {
            const tripItems = document.querySelectorAll('.trip-item');
            tripItems.forEach(item => {
                const tripId = item.getAttribute('data-trip-id');
                if (tripId === activeTrip) {
                    item.classList.add('accepted');
                }
            });
        }

        function updateTripProgress(status) {
            const step1 = document.getElementById('step1');
            const step2 = document.getElementById('step2');
            const step3 = document.getElementById('step3');
            const statusBadge = document.getElementById('tripStatusBadge');

            // Reset all steps
            step1.classList.remove('active');
            step2.classList.remove('active');
            step3.classList.remove('active');

            if (status === 'accepted') {
                step1.classList.add('active');
                statusBadge.className = 'trip-status-badge status-accepted';
                statusBadge.textContent = 'ACCEPTED';
            } else if (status === 'started') {
                step1.classList.add('active');
                step2.classList.add('active');
                statusBadge.className = 'trip-status-badge status-started';
                statusBadge.textContent = 'IN PROGRESS';
            } else if (status === 'ended') {
                step1.classList.add('active');
                step2.classList.add('active');
                step3.classList.add('active');
                statusBadge.className = 'trip-status-badge status-ended';
                statusBadge.textContent = 'COMPLETED';
            }
        }

        function showTrips(trips) {
            const list = document.getElementById("tripsList");
            list.innerHTML = '';

            if (!Array.isArray(trips)) {
                trips = [trips];
            }

            // Filter out trips that already have a driver
            const availableTrips = trips.filter(trip => !trip.driverId || trip.driverId === "28afc03e-ad73-4ddf-828b-6cbf6c552a35");

            if (availableTrips.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 20px; color: #ccc;">No available trips in your zone</div>';
                return;
            }

            availableTrips.forEach(trip => {
                const box = document.createElement("div");
                box.classList.add("trip-item");
                box.setAttribute('data-trip-id', trip.id);

                const isActiveTrip = trip.id === activeTrip;

                if (isActiveTrip) box.classList.add('accepted');

                box.innerHTML = `
                        <strong>üöï Trip ID:</strong> ${trip.id.substring(0, 8)}...<br>
                        <strong>üìç Pickup:</strong> ${trip.pickupCoordinates.lat.toFixed(4)}, ${trip.pickupCoordinates.lng.toFixed(4)}<br>
                        <strong>üéØ Destination:</strong> ${trip.distinationCoordinates.lat.toFixed(4)}, ${trip.distinationCoordinates.lng.toFixed(4)}<br>
                        <strong>üí∞ Price:</strong> ${trip.price?.toFixed(2) || '0.00'} EGP<br>
                        <strong>üìè Distance:</strong> ${trip.distanceKm?.toFixed(2) || '0.00'} km<br>
                        <strong>üí≥ Payment:</strong> ${trip.paymentMethod}<br>
                        <strong>üó∫Ô∏è Zone:</strong> ${trip.zoneId}
                        <div class="trip-controls">
                            ${!isActiveTrip ? `<button class="btn-accept" onclick="acceptTrip('${trip.id}')">Accept Trip</button>` : ''}
                        </div>
                    `;

                list.appendChild(box);
            });
        }

        function showActiveTripInfo(trip) {
            const infoPanel = document.getElementById('activeTripInfo');
            const details = document.getElementById('activeTripDetails');
            const navigation = document.getElementById('tripNavigation');

            details.innerHTML = `
                    <strong>üöï Trip ID:</strong> ${trip.id.substring(0, 8)}...<br>
                    <strong>üìç Pickup:</strong> ${trip.pickupCoordinates.lat.toFixed(4)}, ${trip.pickupCoordinates.lng.toFixed(4)}<br>
                    <strong>üéØ Destination:</strong> ${trip.distinationCoordinates.lat.toFixed(4)}, ${trip.distinationCoordinates.lng.toFixed(4)}<br>
                    <strong>üí∞ Price:</strong> ${trip.price?.toFixed(2) || '0.00'} EGP<br>
                    <strong>üìè Distance:</strong> ${trip.distanceKm?.toFixed(2) || '0.00'} km<br>
                    <strong>üí≥ Payment:</strong> ${trip.paymentMethod}<br>
                    <strong>üó∫Ô∏è Zone:</strong> ${trip.zoneId || 'Unknown'}
                `;

            if (trip.tripStatus === 'Accepted') {
                navigation.innerHTML = `
                        <button class="btn-start" onclick="startTrip('${trip.id}')">Start Trip</button>
                        <button class="btn-end" onclick="endTrip('${trip.id}')">Cancel</button>
                    `;
                updateTripProgress('accepted');
            } else if (trip.tripStatus === 'Started') {
                navigation.innerHTML = `
                        <button class="btn-end" onclick="endTrip('${trip.id}')">End Trip</button>
                    `;
                updateTripProgress('started');
            }

            infoPanel.style.display = 'block';
        }

        // =======================================
        // üõ†Ô∏è UTILITY FUNCTIONS
        // =======================================
        function updateConnectionStatus(status, message) {
            const statusElement = document.getElementById('statusText');
            statusElement.textContent = message;
            statusElement.className = `status-${status}`;
            console.log(`Connection status: ${status} - ${message}`);
        }

        function addDebugLog(message) {
            const debugContent = document.getElementById('debugContent');
            const timestamp = new Date().toLocaleTimeString();
            debugContent.innerHTML = `<div>[${timestamp}] ${message}</div>` + debugContent.innerHTML;
        }

        function toggleDebug() {
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
        }

        // =======================================
        // üö™ WINDOW EVENT HANDLERS
        // =======================================
        window.addEventListener('beforeunload', async () => {
            if (connection && connection.state === signalR.HubConnectionState.Connected) {
                try {
                    await connection.stop();
                    addDebugLog('Connection closed gracefully before page unload');
                } catch (error) {
                    console.error('Error stopping connection:', error);
                }
            }
        });

        window.addEventListener('online', () => {
            addDebugLog('Network connection restored');
            if (!connection || connection.state === signalR.HubConnectionState.Disconnected) {
                startHub();
            }
        });

        window.addEventListener('offline', () => {
            addDebugLog('Network connection lost');
            updateConnectionStatus('disconnected', 'Network Offline');
        });

        // Expose functions to global scope
        window.acceptTrip = acceptTrip;
        window.startTrip = startTrip;
        window.endTrip = endTrip;
        window.toggleDebug = toggleDebug;
        window.initializeApp = initializeApp;
    </script>
</body>
</html>