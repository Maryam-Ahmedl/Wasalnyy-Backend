<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Rider - Uber Clone</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Routing -->
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

    <!-- SignalR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>

    <style>
        html, body {
            height: 100%;
            margin: 0;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        /* CONTROL PANEL */
        #controlPanel {
            position: fixed;
            top: 10px;
            left: 10px;
            width: 350px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            border-radius: 12px;
            z-index: 9999;
            font-family: Arial;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        #tripInfo {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 320px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            border-radius: 12px;
            z-index: 9999;
            font-family: Arial;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .form-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 6px;
            box-sizing: border-box;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 14px;
        }

            input:read-only {
                background: rgba(255,255,255,0.05);
                color: #ccc;
            }

        button {
            width: 100%;
            padding: 12px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background 0.3s;
        }

            button:disabled {
                background: #666;
                cursor: not-allowed;
            }

            button:hover:not(:disabled) {
                background: #45a049;
            }

        .btn-cancel {
            background: #f44336;
        }

            .btn-cancel:hover:not(:disabled) {
                background: #d32f2f;
            }

        .driver-info {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 6px;
            margin-top: 12px;
            border-left: 4px solid #4caf50;
        }

        .zone-label {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            pointer-events: none;
            border: 2px solid #ff6b6b;
        }

        .zone-info {
            margin-top: 12px;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            font-size: 13px;
            border-left: 4px solid #ff6b6b;
        }

        .route-legend {
            position: fixed;
            top: 150px;
            left: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-family: Arial;
            font-size: 12px;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 6px 0;
        }

        .legend-color {
            width: 24px;
            height: 4px;
            margin-right: 10px;
            border-radius: 2px;
        }

        #authPanel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 30px;
            border-radius: 12px;
            z-index: 10000;
            font-family: Arial;
            width: 400px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
        }

        #connectionStatus {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-family: Arial;
            font-size: 12px;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .status-connected {
            color: #4caf50;
        }

        .status-disconnected {
            color: #f44336;
        }

        .status-reconnecting {
            color: #ff9800;
        }

        .location-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .location-btn {
            flex: 1;
            padding: 8px;
            font-size: 12px;
            background: #2196f3;
        }

            .location-btn.active {
                background: #1976d2;
                border: 2px solid #64b5f6;
            }

            .location-btn:hover:not(.active) {
                background: #1976d2;
            }

        .instructions {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 12px;
            border-left: 4px solid #ff9800;
        }

        .marker-instructions {
            position: fixed;
            bottom: 60px;
            left: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-family: Arial;
            font-size: 12px;
            z-index: 9999;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
    </style>
</head>

<body>
    <!-- Authentication Panel -->
    <div id="authPanel">
        <h3 style="text-align: center; margin-bottom: 20px;">üîë Rider Authentication</h3>
        <div class="form-group">
            <label for="riderToken">JWT Token:</label>
            <input type="text" id="riderToken" placeholder="Enter your JWT token">
        </div>
        <div class="form-group">
            <button onclick="initializeApp()">Start Riding</button>
        </div>
    </div>

    <!-- Control Panel -->
    <div id="controlPanel" style="display: none;">
        <h3 style="text-align: center; margin-bottom: 15px;">üöó Request a Ride</h3>
        <form id="tripForm">
            <div class="form-group">
                <label>üìç Pickup Location:</label>
                <input type="text" id="pickupLocation" placeholder="Click 'Set Pickup' then click on map" readonly>
                <input type="hidden" id="pickupLat">
                <input type="hidden" id="pickupLng">
                <div class="location-buttons">
                    <button type="button" class="location-btn" id="setPickupBtn" onclick="setSelectionMode('pickup')">Set Pickup</button>
                    <button type="button" class="location-btn" id="clearPickupBtn" onclick="clearPickupLocation()">Clear</button>
                </div>
            </div>

            <div class="form-group">
                <label>üéØ Destination:</label>
                <input type="text" id="destinationLocation" placeholder="Click 'Set Destination' then click on map" readonly>
                <input type="hidden" id="destinationLat">
                <input type="hidden" id="destinationLng">
                <div class="location-buttons">
                    <button type="button" class="location-btn" id="setDestinationBtn" onclick="setSelectionMode('destination')">Set Destination</button>
                    <button type="button" class="location-btn" id="clearDestinationBtn" onclick="clearDestinationLocation()">Clear</button>
                </div>
            </div>

            <div class="form-group">
                <label>üí≥ Payment Method:</label>
                <select id="paymentMethod">
                    <option value="Cash">Cash</option>
                    <option value="CreditCard">Credit Card</option>
                    <option value="Wallet">Wallet</option>
                </select>
            </div>

            <div id="zoneInfo" class="zone-info" style="display: none;">
                <strong>Current Zone:</strong> <span id="currentZone">None</span>
            </div>

            <div class="instructions">
                üí° <strong>How to set locations:</strong><br>
                1. Click "Set Pickup"<br>
                2. Click on map for pickup<br>
                3. Click "Set Destination"<br>
                4. Click on map for destination
            </div>

            <button type="submit" id="requestTripBtn" style="margin-top: 15px;">Request Trip</button>
            <button type="button" id="cancelTripBtn" class="btn-cancel" style="display: none; margin-top: 8px;">Cancel Trip</button>
        </form>
    </div>

    <!-- Trip Information -->
    <div id="tripInfo">
        <h3 style="text-align: center; margin-bottom: 15px;">üöï Trip Status</h3>
        <div id="tripDetails"></div>
        <div id="driverInfo" class="driver-info" style="display: none;"></div>
    </div>

    <!-- Route Legend -->
    <div id="routeLegend" class="route-legend" style="display: none;">
        <h4 style="margin: 0 0 10px 0; text-align: center;">Route Legend</h4>
        <div class="legend-item">
            <div class="legend-color" style="background: #2196f3;"></div>
            <span>Driver to Pickup</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #4caf50;"></div>
            <span>Pickup to Destination</span>
        </div>
    </div>

    <!-- Connection Status -->
    <div id="connectionStatus" style="display: none;">
        Status: <span id="statusText" class="status-disconnected">Disconnected</span>
    </div>

    <!-- Marker Instructions -->
    <div id="markerInstructions" class="marker-instructions" style="display: none;">
        <div id="instructionsText"></div>
    </div>

    <div id="map" style="display: none;"></div>

    <script>
        // =======================================
        // üîë AUTHENTICATION & INITIALIZATION
        // =======================================
        let token = null;
        let connection = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 10;
        let isAppInitialized = false;
        let pendingTripData = null;
        let currentSelectionMode = null; // 'pickup' or 'destination'

        function initializeApp() {
            token = document.getElementById('riderToken').value.trim();

            if (!token) {
                alert('Please enter a valid JWT token');
                return;
            }

            // Hide auth panel, show app
            document.getElementById('authPanel').style.display = 'none';
            document.getElementById('map').style.display = 'block';
            document.getElementById('controlPanel').style.display = 'block';
            document.getElementById('connectionStatus').style.display = 'block';

            initializeMap();
            initializeConnection();
            startHub();

            isAppInitialized = true;
        }

        // =======================================
        // üó∫Ô∏è MAP SELECTION MODE MANAGEMENT
        // =======================================
        function setSelectionMode(mode) {
            currentSelectionMode = mode;

            // Update button states
            document.getElementById('setPickupBtn').classList.remove('active');
            document.getElementById('setDestinationBtn').classList.remove('active');

            if (mode === 'pickup') {
                document.getElementById('setPickupBtn').classList.add('active');
                showInstructions('Click anywhere on the map to set pickup location');
            } else if (mode === 'destination') {
                document.getElementById('setDestinationBtn').classList.add('active');
                showInstructions('Click anywhere on the map to set destination location');
            }
        }

        function clearSelectionMode() {
            currentSelectionMode = null;
            document.getElementById('setPickupBtn').classList.remove('active');
            document.getElementById('setDestinationBtn').classList.remove('active');
            hideInstructions();
        }

        function showInstructions(text) {
            document.getElementById('markerInstructions').style.display = 'block';
            document.getElementById('instructionsText').textContent = text;
        }

        function hideInstructions() {
            document.getElementById('markerInstructions').style.display = 'none';
        }

        function clearPickupLocation() {
            if (pickupMarker) {
                map.removeLayer(pickupMarker);
                pickupMarker = null;
            }
            document.getElementById('pickupLat').value = '';
            document.getElementById('pickupLng').value = '';
            document.getElementById('pickupLocation').value = '';
            clearSelectionMode();
        }

        function clearDestinationLocation() {
            if (destinationMarker) {
                map.removeLayer(destinationMarker);
                destinationMarker = null;
            }
            document.getElementById('destinationLat').value = '';
            document.getElementById('destinationLng').value = '';
            document.getElementById('destinationLocation').value = '';
            clearSelectionMode();
        }

        // =======================================
        // üõ∞Ô∏è SIGNALR CONNECTION WITH IMPROVED RECONNECTION
        // =======================================
        function initializeConnection() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("https://localhost:7229/Wasalnyy", {
                    accessTokenFactory: () => token,
                    transport: signalR.HttpTransportType.LongPolling | signalR.HttpTransportType.ServerSentEvents | signalR.HttpTransportType.WebSockets
                })
                .withAutomaticReconnect({
                    nextRetryDelayInMilliseconds: retryContext => {
                        reconnectAttempts = retryContext.previousRetryCount;
                        if (retryContext.previousRetryCount >= maxReconnectAttempts) {
                            return null;
                        }
                        return Math.min(1000 * Math.pow(2, retryContext.previousRetryCount), 30000);
                    }
                })
                .configureLogging(signalR.LogLevel.Warning)
                .build();

            setupConnectionHandlers();
        }

        function setupConnectionHandlers() {
            connection.onreconnecting(error => {
                updateConnectionStatus('reconnecting', 'Reconnecting...');
                console.log(`Reconnecting due to: ${error?.message || 'Unknown error'}`);
            });

            connection.onreconnected(connectionId => {
                reconnectAttempts = 0;
                updateConnectionStatus('connected', 'Connected');
                console.log(`Reconnected with ID: ${connectionId}`);

                // Restore state after reconnection
                if (currentTrip) {
                    console.log('Restoring active trip after reconnection');
                }
            });

            connection.onclose(error => {
                updateConnectionStatus('disconnected', 'Disconnected');
                console.log(`Connection closed: ${error?.message || 'Unknown reason'}`);

                // Attempt to reconnect if not manual closure
                if (error) {
                    setTimeout(startHub, 5000);
                }
            });

            // SignalR event handlers
            connection.on("tripAccepeted", (driver) => {
                console.log("üéâ Trip accepted by driver:", driver);

                document.getElementById('driverInfo').style.display = 'block';
                document.getElementById('driverInfo').innerHTML = `
                        <strong>Driver Assigned:</strong><br>
                        <strong>Name:</strong> ${driver.fullName}<br>
                        <strong>Vehicle:</strong> ${driver.vehicle?.model || 'N/A'} ${driver.vehicle?.color || ''}<br>
                        <strong>License:</strong> ${driver.license}<br>
                        <strong>Status:</strong> Driver is on the way to pickup
                    `;

                document.getElementById('tripDetails').innerHTML =
                    document.getElementById('tripDetails').innerHTML.replace('Waiting for driver...', 'Driver on the way');
            });

            connection.on("tripLocationUpdated", (coordinates) => {
                console.log("üìç Driver location updated:", coordinates);
                updateDriverLocation(coordinates);
            });

            connection.on("tripStarted", (trip) => {
                console.log("üöó Trip started:", trip);
                currentTrip = trip;

                document.getElementById('driverInfo').innerHTML =
                    document.getElementById('driverInfo').innerHTML.replace('Driver is on the way to pickup', 'Trip in progress - Going to destination');

                document.getElementById('tripDetails').innerHTML =
                    document.getElementById('tripDetails').innerHTML.replace('Driver on the way', 'Trip in progress');
            });

            connection.on("tripEnded", (trip) => {
                console.log("üèÅ Trip ended:", trip);
                currentTrip = null;

                document.getElementById('tripDetails').innerHTML =
                    document.getElementById('tripDetails').innerHTML.replace('Trip in progress', 'Trip completed');

                document.getElementById('requestTripBtn').disabled = false;
                document.getElementById('cancelTripBtn').style.display = 'none';

                // Reset the form
                clearPickupLocation();
                clearDestinationLocation();

                setTimeout(() => {
                    if (driverMarker) {
                        map.removeLayer(driverMarker);
                        driverMarker = null;
                    }
                    cleanupRoutes();
                    document.getElementById('driverInfo').style.display = 'none';
                    document.getElementById('routeLegend').style.display = 'none';
                    document.getElementById('tripInfo').style.display = 'none';
                }, 5000);
            });

            connection.on("pendingTrip", (trip) => {
                console.log("üîÑ Pending trip restored:", trip);
                pendingTripData = trip;
                currentTrip = trip;

                document.getElementById('tripInfo').style.display = 'block';
                document.getElementById('requestTripBtn').disabled = true;
                document.getElementById('cancelTripBtn').style.display = 'block';

                document.getElementById('tripDetails').innerHTML = `
                        <strong>Status:</strong> ${trip.tripStatus}<br>
                        <strong>Pickup:</strong> ${trip.pickupCoordinates.lat.toFixed(4)}, ${trip.pickupCoordinates.lng.toFixed(4)}<br>
                        <strong>Destination:</strong> ${trip.distinationCoordinates.lat.toFixed(4)}, ${trip.distinationCoordinates.lng.toFixed(4)}<br>
                        <strong>Payment:</strong> ${trip.paymentMethod}<br>
                        <strong>Zone:</strong> ${trip.zoneId || 'Unknown'}
                    `;

                // Restore markers
                if (trip.pickupCoordinates) {
                    setPickupLocation(trip.pickupCoordinates.lat, trip.pickupCoordinates.lng, true);
                }
                if (trip.distinationCoordinates) {
                    setDestinationLocation(trip.distinationCoordinates.lat, trip.distinationCoordinates.lng, true);
                }
            });
        }

        async function startHub() {
            try {
                if (connection && connection.state === signalR.HubConnectionState.Connected) {
                    return;
                }

                updateConnectionStatus('reconnecting', 'Connecting...');
                console.log('Starting connection...');

                await connection.start();
                reconnectAttempts = 0;
                updateConnectionStatus('connected', 'Connected');
                console.log('Successfully connected to SignalR hub');

            } catch (err) {
                reconnectAttempts++;
                updateConnectionStatus('disconnected', 'Connection Failed');

                let errorMessage = err.message;
                if (err.statusCode === 401) {
                    errorMessage = "Authentication failed - Token may be expired";
                } else if (err.statusCode === 404) {
                    errorMessage = "Hub endpoint not found - Check server configuration";
                }

                console.error(`Connection failed (attempt ${reconnectAttempts}): ${errorMessage}`);

                if (reconnectAttempts < maxReconnectAttempts) {
                    const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
                    console.log(`Retrying in ${delay}ms...`);
                    setTimeout(startHub, delay);
                } else {
                    console.error('Max reconnection attempts reached. Please refresh the page.');
                }
            }
        }

        // =======================================
        // üó∫Ô∏è MAP INITIALIZATION WITH IMPROVED MARKERS
        // =======================================
        let map, pickupMarker, destinationMarker, driverMarker;
        let pickupRouteControl, destinationRouteControl;
        let currentTrip = null;
        let currentTripData = null;

        // Custom icons for better visibility
        const pickupIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
            iconSize: [32, 32],
            iconAnchor: [16, 16],
            popupAnchor: [0, -16]
        });

        const destinationIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/3474/3474365.png',
            iconSize: [32, 32],
            iconAnchor: [16, 16],
            popupAnchor: [0, -16]
        });

        const driverIcon = L.icon({
            iconUrl: 'car.png',
            iconSize: [40, 40],
            iconAnchor: [20, 20],
            popupAnchor: [0, -20]
        });

        function initializeMap() {
            map = L.map("map").setView([30.06, 31.40], 12);
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

            drawZones();

            // Enhanced map click handler for location selection
            map.on('click', function (e) {
                const clickedZone = getZoneForLocation(e.latlng.lat, e.latlng.lng);
                updateZoneInfo(clickedZone);

                if (currentSelectionMode === 'pickup') {
                    setPickupLocation(e.latlng.lat, e.latlng.lng);
                    clearSelectionMode();
                } else if (currentSelectionMode === 'destination') {
                    setDestinationLocation(e.latlng.lat, e.latlng.lng);
                    clearSelectionMode();
                } else {
                    // If no selection mode is active, show zone info
                    if (clickedZone) {
                        showInstructions(`Clicked in ${clickedZone}. Click "Set Pickup" or "Set Destination" to choose a location.`);
                        setTimeout(hideInstructions, 3000);
                    }
                }
            });

            // Add right-click context menu to clear locations
            map.on('contextmenu', function (e) {
                if (pickupMarker && map.distance(e.latlng, pickupMarker.getLatLng()) < 50) {
                    clearPickupLocation();
                } else if (destinationMarker && map.distance(e.latlng, destinationMarker.getLatLng()) < 50) {
                    clearDestinationLocation();
                }
            });
        }

        function setPickupLocation(lat, lng, fromRestore = false) {
            if (pickupMarker) {
                map.removeLayer(pickupMarker);
            }

            pickupMarker = L.marker([lat, lng], {
                icon: pickupIcon,
                draggable: true
            })
                .addTo(map)
                .bindPopup(`
                    <div style="text-align: center;">
                        <strong>üìç Pickup Location</strong><br>
                        ${lat.toFixed(4)}, ${lng.toFixed(4)}<br>
                        <small>Right-click to remove</small>
                    </div>
                `)
                .openPopup();

            // Make marker draggable
            pickupMarker.on('dragend', function (event) {
                const marker = event.target;
                const position = marker.getLatLng();
                document.getElementById('pickupLat').value = position.lat;
                document.getElementById('pickupLng').value = position.lng;
                document.getElementById('pickupLocation').value = `${position.lat.toFixed(4)}, ${position.lng.toFixed(4)}`;

                // Update zone info
                const pickupZone = getZoneForLocation(position.lat, position.lng);
                updateZoneInfo(pickupZone);
            });

            document.getElementById('pickupLat').value = lat;
            document.getElementById('pickupLng').value = lng;
            document.getElementById('pickupLocation').value = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;

            const pickupZone = getZoneForLocation(lat, lng);
            updateZoneInfo(pickupZone);

            if (!fromRestore) {
                console.log(`üìç Pickup set to: ${lat}, ${lng}`);
                showInstructions('Pickup location set! Now click "Set Destination" to choose destination.');
                setTimeout(hideInstructions, 3000);
            }

            // Auto-fit map to show both markers if destination is also set
            if (destinationMarker) {
                const group = new L.FeatureGroup([pickupMarker, destinationMarker]);
                map.fitBounds(group.getBounds().pad(0.1));
            } else {
                map.setView([lat, lng], 14);
            }
        }

        function setDestinationLocation(lat, lng, fromRestore = false) {
            if (destinationMarker) {
                map.removeLayer(destinationMarker);
            }

            destinationMarker = L.marker([lat, lng], {
                icon: destinationIcon,
                draggable: true
            })
                .addTo(map)
                .bindPopup(`
                    <div style="text-align: center;">
                        <strong>üéØ Destination</strong><br>
                        ${lat.toFixed(4)}, ${lng.toFixed(4)}<br>
                        <small>Right-click to remove</small>
                    </div>
                `)
                .openPopup();

            // Make marker draggable
            destinationMarker.on('dragend', function (event) {
                const marker = event.target;
                const position = marker.getLatLng();
                document.getElementById('destinationLat').value = position.lat;
                document.getElementById('destinationLng').value = position.lng;
                document.getElementById('destinationLocation').value = `${position.lat.toFixed(4)}, ${position.lng.toFixed(4)}`;
            });

            document.getElementById('destinationLat').value = lat;
            document.getElementById('destinationLng').value = lng;
            document.getElementById('destinationLocation').value = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;

            if (!fromRestore) {
                console.log(`üéØ Destination set to: ${lat}, ${lng}`);
                showInstructions('Destination set! You can now request a trip.');
                setTimeout(hideInstructions, 3000);
            }

            // Auto-fit map to show both markers
            if (pickupMarker) {
                const group = new L.FeatureGroup([pickupMarker, destinationMarker]);
                map.fitBounds(group.getBounds().pad(0.1));
            } else {
                map.setView([lat, lng], 14);
            }
        }

        // =======================================
        // üó∫Ô∏è ZONES DATA & UTILITIES
        // =======================================
        const zones = [
            {
                "id": "Zone_1",
                "center": { "lat": 29.9, "lng": 31 },
                "coordinates": [
                    { "lat": 29.886486486486486, "lng": 30.984388949539976 },
                    { "lat": 29.886486486486486, "lng": 31.015611050460024 },
                    { "lat": 29.91351351351351, "lng": 31.015611050460024 },
                    { "lat": 29.91351351351351, "lng": 30.984388949539976 },
                    { "lat": 29.886486486486486, "lng": 30.984388949539976 }
                ]
            },
            // ... (other zones remain the same)
        ];

        function drawZones() {
            zones.forEach(zone => {
                const polygon = L.polygon(zone.coordinates, {
                    color: '#ff6b6b',
                    weight: 2,
                    fillColor: '#ff6b6b',
                    fillOpacity: 0.1,
                    className: 'zone-polygon'
                }).addTo(map);

                L.marker(zone.center, {
                    icon: L.divIcon({
                        className: 'zone-label',
                        html: zone.id,
                        iconSize: [60, 20],
                        iconAnchor: [30, 10]
                    })
                }).addTo(map);

                polygon.on('mouseover', function () {
                    this.setStyle({ fillOpacity: 0.2, weight: 3 });
                });

                polygon.on('mouseout', function () {
                    this.setStyle({ fillOpacity: 0.1, weight: 2 });
                });

                polygon.on('click', function () {
                    console.log(`Zone clicked: ${zone.id}`);
                    updateZoneInfo(zone.id);
                    showInstructions(`Zone ${zone.id} selected. Click "Set Pickup" or "Set Destination" to choose a location in this zone.`);
                    setTimeout(hideInstructions, 3000);
                });
            });
        }

        function getZoneForLocation(lat, lng) {
            for (const zone of zones) {
                if (isPointInPolygon({ lat, lng }, zone.coordinates)) {
                    return zone.id;
                }
            }
            return null;
        }

        function isPointInPolygon(point, polygon) {
            const x = point.lat, y = point.lng;
            let inside = false;
            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                const xi = polygon[i].lat, yi = polygon[i].lng;
                const xj = polygon[j].lat, yj = polygon[j].lng;

                const intersect = ((yi > y) !== (yj > y)) &&
                    (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }
            return inside;
        }

        function updateZoneInfo(zoneId) {
            const zoneInfo = document.getElementById('zoneInfo');
            const currentZone = document.getElementById('currentZone');

            if (zoneId) {
                zoneInfo.style.display = 'block';
                currentZone.textContent = zoneId;
            } else {
                zoneInfo.style.display = 'none';
            }
        }

        // =======================================
        // üß≠ ROUTE MANAGEMENT WITH RETRY
        // =======================================
        function showBothRoutes(driverCoords, pickupCoords, destinationCoords) {
            cleanupRoutes();

            const driverPosition = L.latLng(driverCoords.lat, driverCoords.lng);
            const pickupPosition = L.latLng(pickupCoords.lat, pickupCoords.lng);
            const destinationPosition = L.latLng(destinationCoords.lat, destinationCoords.lng);

            if (driverMarker) {
                driverMarker.setLatLng(driverPosition);
            } else {
                driverMarker = L.marker(driverPosition, { icon: driverIcon })
                    .addTo(map)
                    .bindPopup('Your Driver')
                    .openPopup();
            }

            // Create routes with retry mechanism
            createRouteWithRetry(driverPosition, pickupPosition, '#2196f3', 'pickup')
                .then(control => {
                    pickupRouteControl = control;
                    return createRouteWithRetry(pickupPosition, destinationPosition, '#4caf50', 'destination');
                })
                .then(control => {
                    destinationRouteControl = control;
                    document.getElementById('routeLegend').style.display = 'block';

                    const group = new L.FeatureGroup([driverMarker, pickupMarker, destinationMarker]);
                    map.fitBounds(group.getBounds().pad(0.1));
                    console.log("üó∫Ô∏è Showing both routes on rider map");
                })
                .catch(error => {
                    console.error("‚ùå Route creation failed:", error);
                });
        }

        function createRouteWithRetry(start, end, color, routeType, maxRetries = 3) {
            return new Promise((resolve, reject) => {
                let attempts = 0;

                function attempt() {
                    const control = L.Routing.control({
                        waypoints: [start, end],
                        createMarker: () => null,
                        show: true,
                        addWaypoints: false,
                        routeWhileDragging: false,
                        lineOptions: {
                            styles: [{ color: color, weight: 5, opacity: 0.7 }]
                        }
                    }).addTo(map);

                    const timeout = setTimeout(() => {
                        map.removeControl(control);
                        attempts++;

                        if (attempts < maxRetries) {
                            console.log(`Retrying ${routeType} route calculation (attempt ${attempts + 1})`);
                            attempt();
                        } else {
                            reject(new Error(`Failed to calculate ${routeType} route after ${maxRetries} attempts`));
                        }
                    }, 10000);

                    control.on("routesfound", (evt) => {
                        clearTimeout(timeout);
                        if (evt.routes && evt.routes.length > 0) {
                            resolve(control);
                        } else {
                            map.removeControl(control);
                            reject(new Error(`No routes found for ${routeType}`));
                        }
                    });

                    control.on("routingerror", (error) => {
                        clearTimeout(timeout);
                        map.removeControl(control);
                        attempts++;

                        if (attempts < maxRetries) {
                            console.log(`Retrying ${routeType} route after error (attempt ${attempts + 1})`);
                            attempt();
                        } else {
                            reject(new Error(`Routing error for ${routeType}: ${error.error.message}`));
                        }
                    });
                }

                attempt();
            });
        }

        function cleanupRoutes() {
            if (pickupRouteControl) {
                map.removeControl(pickupRouteControl);
                pickupRouteControl = null;
            }
            if (destinationRouteControl) {
                map.removeControl(destinationRouteControl);
                destinationRouteControl = null;
            }
        }

        function updateDriverLocation(coordinates) {
            if (driverMarker) {
                driverMarker.setLatLng([coordinates.lat, coordinates.lng]);

                if (currentTripData && currentTripData.pickupCoordinates && currentTripData.distinationCoordinates) {
                    showBothRoutes(
                        coordinates,
                        currentTripData.pickupCoordinates,
                        currentTripData.distinationCoordinates
                    );
                }
            } else {
                driverMarker = L.marker([coordinates.lat, coordinates.lng], { icon: driverIcon })
                    .addTo(map)
                    .bindPopup('Your Driver')
                    .openPopup();
            }
        }

        // =======================================
        // üöó TRIP MANAGEMENT
        // =======================================
        document.getElementById('tripForm').addEventListener('submit', function (e) {
            e.preventDefault();
            requestTrip();
        });

        document.getElementById('cancelTripBtn').addEventListener('click', function () {
            if (confirm('Are you sure you want to cancel this trip?')) {
                // Implement cancel trip functionality
                alert('Cancel trip functionality to be implemented');
            }
        });

        async function apiCallWithRetry(url, options, maxRetries = 3) {
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return response;

                    if (attempt === maxRetries) {
                        throw new Error(`API call failed after ${maxRetries} attempts: ${response.status}`);
                    }
                } catch (error) {
                    if (attempt === maxRetries) throw error;
                    await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                }
            }
        }

        function requestTrip() {
            const pickupLat = document.getElementById('pickupLat').value;
            const pickupLng = document.getElementById('pickupLng').value;
            const destinationLat = document.getElementById('destinationLat').value;
            const destinationLng = document.getElementById('destinationLng').value;
            const paymentMethod = document.getElementById('paymentMethod').value;

            if (!pickupLat || !destinationLat) {
                alert('Please set both pickup and destination locations');
                return;
            }

            const tripData = new FormData();
            tripData.append('PaymentMethod', paymentMethod);
            tripData.append('PickupCoordinates.Lat', pickupLat);
            tripData.append('PickupCoordinates.Lng', pickupLng);
            tripData.append('DistinationCoordinates.Lat', destinationLat);
            tripData.append('DistinationCoordinates.Lng', destinationLng);

            apiCallWithRetry("https://localhost:7229/api/Trip/Request", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${token}`
                },
                body: tripData
            })
                .then(response => {
                    if (response.ok) {
                        console.log("‚úî Trip requested successfully");
                        document.getElementById('requestTripBtn').disabled = true;
                        document.getElementById('cancelTripBtn').style.display = 'block';
                        document.getElementById('tripInfo').style.display = 'block';

                        const pickupZone = getZoneForLocation(parseFloat(pickupLat), parseFloat(pickupLng));

                        currentTripData = {
                            pickupCoordinates: { lat: parseFloat(pickupLat), lng: parseFloat(pickupLng) },
                            distinationCoordinates: { lat: parseFloat(destinationLat), lng: parseFloat(destinationLng) }
                        };

                        document.getElementById('tripDetails').innerHTML = `
                            <strong>Status:</strong> Waiting for driver...<br>
                            <strong>Pickup:</strong> ${parseFloat(pickupLat).toFixed(4)}, ${parseFloat(pickupLng).toFixed(4)}<br>
                            <strong>Destination:</strong> ${parseFloat(destinationLat).toFixed(4)}, ${parseFloat(destinationLng).toFixed(4)}<br>
                            <strong>Payment:</strong> ${paymentMethod}<br>
                            <strong>Zone:</strong> ${pickupZone || 'Unknown'}
                        `;

                        showInstructions('Trip requested! Waiting for driver to accept...');
                        setTimeout(hideInstructions, 3000);
                    }
                })
                .catch(error => {
                    console.error("‚ùå Error requesting trip:", error);
                    alert('Failed to request trip. Please try again.');
                });
        }

        // =======================================
        // üõ†Ô∏è UTILITY FUNCTIONS
        // =======================================
        function updateConnectionStatus(status, message) {
            const statusElement = document.getElementById('statusText');
            statusElement.textContent = message;
            statusElement.className = `status-${status}`;
            console.log(`Connection status: ${status} - ${message}`);
        }

        // =======================================
        // üö™ WINDOW EVENT HANDLERS
        // =======================================
        window.addEventListener('beforeunload', async () => {
            if (connection && connection.state === signalR.HubConnectionState.Connected) {
                try {
                    await connection.stop();
                    console.log('Connection closed gracefully before page unload');
                } catch (error) {
                    console.error('Error stopping connection:', error);
                }
            }
        });

        window.addEventListener('online', () => {
            console.log('Network connection restored');
            if (!connection || connection.state === signalR.HubConnectionState.Disconnected) {
                startHub();
            }
        });

        window.addEventListener('offline', () => {
            console.log('Network connection lost');
            updateConnectionStatus('disconnected', 'Network Offline');
        });

        // Expose functions to global scope
        window.initializeApp = initializeApp;
        window.setSelectionMode = setSelectionMode;
        window.clearPickupLocation = clearPickupLocation;
        window.clearDestinationLocation = clearDestinationLocation;
    </script>
</body>
</html>